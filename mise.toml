[tools]
node = '24'
rust = "latest"
"github:aliev/baker" = "latest"
"cargo:cargo-chef" = "latest"
"cargo:cargo-tarpaulin" = "latest"
"cargo:cargo-deny" = "latest"
pnpm = "latest"
"npm:playwright" = "latest"
protoc = "latest"

[tasks.generate]
description = "Generate the project files"
run = "baker . ./generated/$ANSWER --answers-file sample/answers-$ANSWER.json --force --non-interactive --skip-confirms all"

[tasks.frontend]
description = "Build frontend"
run = '''
cd generated/$ANSWER/frontend
pnpm install --no-frozen-lockfile
pnpm run build
'''
depends = ["generate"]

[tasks.build]
description = "Build the project"
run = '''
cd generated/$ANSWER
cargo build --release
'''
depends = ["generate"]

[tasks.test]
description = "Run tests with code coverage"
run = '''
cd generated/$ANSWER
cargo tarpaulin --out Html --out Lcov --output-dir target/coverage
'''
depends = ["build"]

[tasks.audit]
description = "Check for vulnerabilities using cargo deny"
run = '''
cd generated/$ANSWER
cargo deny check
'''
depends = ["test"]

[tasks.docker-build]
description = "Build Docker images"
run = '''
cd generated/$ANSWER
docker build -t app-e2e-test .
'''
depends = ["test"]

[tasks.e2e]
description = "Run e2e tests"
run = '''
cd generated/$ANSWER/e2e
cargo test
'''
depends = ["docker-build"]

[tasks.rest]
description = "Generate and build rest sample"
env.ANSWER = "rest"
run = ["mise run e2e"]

[tasks.rest-jwt]
description = "Generate and build rest-jwt sample"
env.ANSWER = "rest-jwt"
run = ["mise run e2e"]

[tasks.rest-shadcn]
description = "Generate and build rest-shadcn sample"
env.ANSWER = "rest-shadcn"
run = ["mise run frontend", "mise run e2e"]

[tasks.grpc]
description = "Generate and build grpc sample"
env.ANSWER = "grpc"
run = ["mise run e2e"]

[tasks.all]
description = "Generate and build all samples"
run = ["mise run rest", "mise run rest-jwt", "mise run rest-shadcn", "mise run grpc"]